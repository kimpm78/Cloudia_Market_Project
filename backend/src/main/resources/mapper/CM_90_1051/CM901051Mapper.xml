<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_90_1051.mapper.CM901051Mapper">
    <select id="findByAllOrders" resultType="com.cloudia.backend.CM_90_1051.model.OrderDto">
        SELECT o.order_id
              ,o.member_number
              ,u.login_id
              ,u.name
              ,o.order_number
              ,o.total_amount
              ,o.payment_value
              ,o.order_status_value
              ,o.order_date
              ,o.tracking_number
              ,o.shipping_date
              ,o.delivery_date
        FROM   orders o
        LEFT JOIN users u
        ON     o.member_number = u.member_number
        ORDER BY 
               o.order_date
              ,o.order_status_value
              ,o.order_number
              ,o.member_number
    </select>
    
    <select id="getFindOrders" 
            parameterType="com.cloudia.backend.CM_90_1051.model.SearchRequestDto" 
            resultType="com.cloudia.backend.CM_90_1051.model.OrderDto">
        SELECT o.order_id
              ,o.member_number
              ,u.login_id
              ,u.name
              ,o.order_number
              ,o.total_amount
              ,o.payment_value
              ,o.order_status_value
              ,COALESCE(o.order_date, o.created_at) AS order_date
              ,u.email
        FROM   orders o
        LEFT JOIN users u
        ON     o.member_number = u.member_number
        WHERE 1=1
        <if test="dateFrom != null and dateFrom != ''">
            AND COALESCE(o.order_date, o.created_at) <![CDATA[>=]]> #{dateFrom}::date
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND COALESCE(o.order_date, o.created_at) <![CDATA[<]]> #{dateTo}::date + INTERVAL '1 day'
        </if>
        <if test="orderNumber != 0">
            AND o.order_number = #{orderNumber}
        </if>
        <if test="memberNumber != 0">
            AND o.member_number = #{memberNumber}
        </if>
        <if test="paymentMethod != 0">
            AND o.payment_value = #{paymentMethod}
        </if>
        ORDER BY 
               COALESCE(o.order_date, o.created_at)
              ,o.order_status_value
              ,o.order_number
              ,o.member_number
    </select>

    <select id="getFindOrder" 
            parameterType="com.cloudia.backend.CM_90_1051.model.SearchRequestDto" 
            resultType="com.cloudia.backend.CM_90_1051.model.OrderDto">
        SELECT o.order_id
              ,o.member_number
              ,u.login_id
              ,u.name
              ,o.order_number
              ,o.total_amount
              ,o.payment_value
              ,o.order_status_value
              ,COALESCE(o.order_date, o.created_at) AS order_date
              ,u.email
              ,o.tracking_number
              ,o.shipping_date
              ,o.delivery_date
        FROM   orders o
        LEFT JOIN users u
        ON     o.member_number = u.member_number
        WHERE 1=1
        <if test="dateFrom != null and dateFrom != ''">
            AND COALESCE(o.order_date, o.created_at) <![CDATA[>=]]> #{dateFrom}::date
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND COALESCE(o.order_date, o.created_at) <![CDATA[<]]> #{dateTo}::date + INTERVAL '1 day'
        </if>
        <if test="orderStatusValue != 0">
            AND o.order_status_value = #{orderStatusValue}
        </if>
        <if test="paymentMethod != 0">
            AND o.payment_value = #{paymentMethod}
        </if>
        ORDER BY 
               COALESCE(o.order_date, o.created_at)
              ,o.order_status_value
              ,o.order_number
              ,o.member_number
    </select>

    <select id="getFindOrderDetail" 
            parameterType="com.cloudia.backend.CM_90_1051.model.SearchRequestDto" 
            resultType="com.cloudia.backend.CM_90_1051.model.OrderDetailDto">
        SELECT od.order_detail_id
              ,pc.product_name
              ,od.quantity
              ,od.total_price
              ,od.unit_price
        FROM   order_details od
        LEFT JOIN product_code  pc
        ON     od.product_code = pc.product_code
        WHERE CAST(pc.is_display AS TEXT) = '1'
        AND   od.member_number = #{memberNumber}
        AND   od.order_number  = #{orderNumber}
        ORDER BY 
               od.order_detail_id
    </select>

    <select id="getAddress" 
            parameterType="com.cloudia.backend.CM_90_1051.model.SearchRequestDto" 
            resultType="com.cloudia.backend.CM_90_1051.model.AddressDto">
        SELECT da.address_nickname
              ,da.recipient_name
              ,da.postal_code
              ,da.address_main
              ,da.address_detail1
              ,da.address_detail2
              ,da.address_detail3
        FROM   orders o
        LEFT JOIN delivery_addresses  da
        ON     o.member_number = da.member_number 
        AND    o.shipping_address_id = da.address_id
        WHERE da.deleted_at IS NULL
        AND   o.member_number = #{memberNumber}
        AND   o.order_number  = #{orderNumber}
    </select>

    <update id="uptStatus" parameterType="com.cloudia.backend.CM_90_1051.model.OrderDto">
        UPDATE orders
        SET    order_status_value = #{orderStatusValue}
            <if test="shippingCompany neq null">
               ,shipping_company = #{shippingCompany}
            </if>
            <if test="trackingNumber neq null">
               ,tracking_number = #{trackingNumber}
            </if>
            <if test="shippingDate neq null">
               ,shipping_date = #{shippingDate}
            </if>
              ,updated_by = #{updatedBy}
              ,updated_at = #{updatedAt}
        WHERE member_number = #{memberNumber}
        AND   order_number  = #{orderNumber}
    </update>

    <select id="findLatestTransactionIdByOrderId" resultType="string">
        SELECT p.transaction_id
        FROM payments p
        WHERE p.order_id = #{orderId}
        ORDER BY p.updated_at DESC NULLS LAST, p.created_at DESC NULLS LAST
        LIMIT 1
    </select>

    <update id="updateLatestPaymentTransactionIdByOrderId">
        UPDATE payments
        SET transaction_id = #{transactionId},
            approved_at = COALESCE(approved_at, NOW()),
            updated_by = COALESCE(#{updatedBy}, 'system'),
            updated_at = NOW()
        WHERE payment_id = (
            SELECT p.payment_id
            FROM payments p
            WHERE p.order_id = #{orderId}
            ORDER BY p.updated_at DESC NULLS LAST, p.created_at DESC NULLS LAST
            LIMIT 1
        )
          AND (transaction_id IS NULL OR BTRIM(transaction_id) = '')
    </update>

    <insert id="insertLocalMockCardPaymentIfMissing">
        INSERT INTO payments (
            payment_id,
            order_id,
            order_number,
            payment_type,
            payment_code,
            payment_status_type,
            payment_status_code,
            amount,
            transaction_id,
            pg_provider,
            approved_at,
            created_by,
            created_at,
            updated_by,
            updated_at
        )
        SELECT
            (SELECT COALESCE(MAX(p.payment_id), 0) + 1 FROM payments p),
            o.order_id,
            LPAD(
                (
                    COALESCE(
                        (
                            SELECT MAX(
                                CASE
                                    WHEN p2.order_number ~ '^[0-9]+$' THEN CAST(p2.order_number AS BIGINT)
                                    ELSE NULL
                                END
                            )
                            FROM payments p2
                        ),
                        0
                    ) + 1
                )::text,
                7,
                '0'
            ),
            '011',
            2,
            '013',
            2,
            COALESCE(o.total_amount, 0),
            #{transactionId},
            'LOCAL_MOCK',
            NOW(),
            COALESCE(#{updatedBy}, 'system'),
            NOW(),
            COALESCE(#{updatedBy}, 'system'),
            NOW()
        FROM orders o
        WHERE o.order_id = #{orderId}
          AND NOT EXISTS (
              SELECT 1
              FROM payments p3
              WHERE p3.order_id = o.order_id
          )
    </insert>
</mapper>
