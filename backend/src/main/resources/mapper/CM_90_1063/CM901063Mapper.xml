<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_90_1063.mapper.CM901063Mapper">
    <select id="findAllProductCode" resultType="com.cloudia.backend.CM_90_1063.model.ProductCode">
        SELECT product_code
              ,product_name
          FROM product_code
         WHERE is_display = '1'
      ORDER BY product_code ASC;
    </select>
    
    <select id="findByProductCode" resultType="com.cloudia.backend.CM_90_1063.model.Stock">
        SELECT s.stock_id
              ,s.product_code
              ,s.price
              ,s.total_qty
              ,s.available_qty
              ,CAST(p.product_category_code AS VARCHAR) AS productCategory
              ,s.updated_by
              ,s.updated_at
          FROM product_code p
          LEFT JOIN stocks s
            ON s.product_code = p.product_code
         WHERE p.product_code = #{productCode}
           AND p.is_display = '1'
    </select>

    <select id="findAllStocks" resultType="com.cloudia.backend.CM_90_1063.model.StockInfo">
        SELECT  
            stock_details.stock_detail_id,
            stocks.product_code,
            product_code.product_name,
            stock_details.qty,
            stock_details.reason,
            stock_details.created_by,
            stock_details.created_at
        FROM stocks
        LEFT JOIN stock_details 
            ON stocks.stock_id = stock_details.stock_id
        LEFT JOIN product_code 
            ON stocks.product_code = product_code.product_code
           AND product_code.is_display = '1'
        ORDER BY stock_details.created_at DESC
    </select>

    <select id="findByStocks" resultType="com.cloudia.backend.CM_90_1063.model.StockInfo">
        SELECT  
            stock_details.stock_detail_id,
            stocks.product_code,
            product_code.product_name,
            stock_details.qty,
            stock_details.reason,
            stock_details.created_by,
            stock_details.created_at
        FROM stocks
        LEFT JOIN stock_details 
            ON stocks.stock_id = stock_details.stock_id
        LEFT JOIN product_code 
            ON stocks.product_code = product_code.product_code
           AND product_code.is_display = '1'
        <where>
            <if test='searchType == "1"'>
                AND stocks.product_code LIKE CONCAT('%', #{searchTerm}, '%')
            </if>
            <if test='searchType == "2"'>
                AND product_code.product_name ILIKE CONCAT('%', #{searchTerm}, '%')
            </if>
        </where>
        ORDER BY stock_details.created_at
    </select>

    <insert id="insertStock" parameterType="com.cloudia.backend.CM_90_1063.model.Stock">
        INSERT INTO stocks (
            product_code, price, defective_qty, total_qty,
            available_qty, created_by, created_at,
            updated_by, updated_at
        )
        VALUES (
            #{productCode}, #{price}, #{defectiveQty}, #{totalQty},
            #{availableQty}, #{createdBy}, #{createdAt},
            #{updatedBy}, #{updatedAt}
        )
    </insert>

    <update id="updateStock" parameterType="com.cloudia.backend.CM_90_1063.model.Stock">
        UPDATE stocks
        SET
            price = #{price},
            total_qty = #{totalQty},
            available_qty = #{availableQty},
            updated_by = #{updatedBy},
            updated_at = #{updatedAt}
        WHERE product_code = #{productCode}
    </update>

    <insert id="insertStockDetail" parameterType="com.cloudia.backend.CM_90_1063.model.StockDetail">
        INSERT INTO stock_details (
            stock_id, qty, reason, created_by, 
            created_at, updated_by, updated_at
        )
        VALUES (
            #{stockId}, #{qty}, #{reason}, #{createdBy}, 
            #{createdAt}, #{updatedBy}, #{updatedAt}
        )
    </insert>
</mapper>
