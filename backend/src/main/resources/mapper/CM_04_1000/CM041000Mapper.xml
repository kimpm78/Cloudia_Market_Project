<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_04_1000.mapper.CM041000Mapper">

    <!-- レビューの論理削除 -->
    <delete id="deleteReview" parameterType="map">
        UPDATE reviews
        SET    is_display = '0'
              ,updated_by  = #{updatedBy}
              ,updated_at  = NOW()
        WHERE review_id = #{reviewId}
          AND member_number = (
                SELECT u.member_number
                FROM users u
                WHERE u.user_id = CAST(#{userId} AS BIGINT)
                LIMIT 1
          )
    </delete>

    <!-- レビュー内容の修正 -->
    <update id="updateReviewContent" parameterType="map">
        UPDATE reviews
        SET    content    = #{content}
              ,updated_by = COALESCE(#{updatedBy}, updated_by)
              ,updated_at = NOW()
        WHERE  review_id  = #{reviewId}
          AND  is_display = '1'
    </update>

    <!-- レビューのメイン画像更新 -->
    <update id="updateReviewImage" parameterType="map">
        UPDATE reviews
        SET    image_url  = #{imageUrl}
              ,updated_at = NOW()
        WHERE  review_id  = #{reviewId}
          AND  is_display = '1'
    </update>

    <!-- レビュー一覧取得（productIdがない場合は全件取得）-->
    <select id="selectReviews"
            parameterType="map"
            resultType="com.cloudia.backend.CM_04_1000.model.ReviewInfo">
        SELECT r.review_id  AS reviewId
              ,u.user_id    AS userId
              ,r.product_id AS productId
              ,r.review_type AS reviewType
              ,r.title      AS title
              ,r.image_url  AS imageUrl
              ,r.content    AS content
              ,r.view_count AS viewCount
              ,r.created_by AS createdBy
              ,r.created_at AS createdAt
              ,r.updated_at AS updatedAt
              ,NULLIF(SUBSTRING(r.content FROM 1 FOR 100), '') AS summary
          FROM reviews r
          LEFT JOIN users u
            ON u.member_number = r.member_number
         WHERE r.is_display = '1'
        <if test="productId != null">
           AND r.product_id = #{productId}
        </if>
         ORDER BY r.created_at DESC
                 ,r.review_id  DESC
        <if test="size != null and offset != null">
           LIMIT  #{size}
          OFFSET  #{offset}
        </if>
    </select>

    <!-- レビュー作成 -->
    <insert id="writeReview"
            parameterType="com.cloudia.backend.CM_04_1000.model.ReviewRequest"
            useGeneratedKeys="true"
            keyProperty="reviewId"
            keyColumn="review_id">
        INSERT INTO reviews (
            member_number
           ,order_number
           ,product_id
           ,product_code
           ,review_type
           ,title
           ,image_url
           ,content
           ,view_count
           ,is_display
           ,created_by
           ,created_at
           ,updated_by
           ,updated_at
        )
        VALUES (
            #{memberNumber}
           ,#{orderNumber}
           ,#{productId}
           ,#{productCode}
           ,#{reviewType}
           ,#{title}
           ,#{imageUrl}
           ,#{content}
           ,0
           ,'1'
           ,#{createdBy}
           ,NOW()
           ,#{createdBy}
           ,NOW()
        )
        RETURNING review_id
    </insert>

    <!-- レビュー詳細取得 -->
    <select id="selectReviewById"
            parameterType="long"
            resultType="com.cloudia.backend.CM_04_1000.model.ReviewInfo">
        SELECT r.review_id   AS reviewId
              ,u.user_id     AS userId
              ,r.product_id  AS productId
              ,r.review_type AS reviewType
              ,r.title       AS title
              ,r.image_url   AS imageUrl
              ,r.content     AS content
              ,r.view_count  AS viewCount
              ,r.created_by  AS createdBy
              ,r.created_at  AS createdAt
              ,r.updated_by  AS updatedBy
              ,r.updated_at  AS updatedAt
              ,(
                    SELECT COUNT(1)
                      FROM review_comments rc
                     WHERE rc.review_id = r.review_id
                       AND rc.is_display = '1'
               ) AS commentCount
          FROM reviews r
          LEFT JOIN users u
            ON u.member_number = r.member_number
         WHERE r.review_id   = #{reviewId, jdbcType=BIGINT}
           AND r.is_display = '1'
    </select>

    <!-- 注文に紐づく商品情報を含む結果マッピング -->
    <resultMap id="OrderWithProductsMap" type="com.cloudia.backend.CM_04_1000.model.OrderDetailResponse">
        <id     property="orderId"      column="orderId"/>
        <result property="memberNumber" column="memberNumber"/>
        <result property="orderNumber"  column="orderNumber"/>
        <result property="orderDate"    column="orderDate"/>
        <collection property="products" ofType="com.cloudia.backend.CM_04_1000.model.ProductInfo">
            <result property="productCode" column="productCode"/>
            <result property="productId"   column="productId"/>
            <result property="productName" column="productName"/>
        </collection>
    </resultMap>

    <!-- 注文と商品情報をあわせて取得 -->
    <select id="selectOrdersWithProducts"
            resultMap="OrderWithProductsMap"
            parameterType="string">
        SELECT o.order_id      AS orderId
              ,o.member_number AS memberNumber
              ,o.order_number  AS orderNumber
              ,o.order_date    AS orderDate
              ,p.product_id    AS productId
              ,p.product_code  AS productCode
              ,p.title         AS productName
          FROM orders o
          JOIN order_details d
            ON o.member_number = d.member_number
           AND o.order_number  = d.order_number
          JOIN products p
            ON p.product_code  = d.product_code
         WHERE o.member_number = #{memberNumber}
         ORDER BY o.order_date ASC
    </select>

    <!-- レビュー作成前に購入履歴を確認 -->
    <select id="checkOrderProduct"
            parameterType="map"
            resultType="int">
        SELECT COUNT(1)
          FROM orders o
          JOIN order_details od
            ON o.member_number = od.member_number
           AND o.order_number  = od.order_number
          JOIN products p
            ON p.product_code  = od.product_code
         WHERE o.member_number = #{memberNumber}
           AND o.order_number  = #{orderNumber}
           AND p.product_code  = #{productCode}
    </select>

    <!-- 商品コードから商品IDを取得 -->
    <select id="findProductIdByCode"
            parameterType="string"
            resultType="long">
        SELECT product_id
          FROM products
         WHERE product_code = #{productCode}
         LIMIT 1
    </select>

    <!-- レビュー添付ファイル挿入 -->
    <insert id="insertReviewAttachment"
            parameterType="com.cloudia.backend.CM_04_1000.model.Attachments"
            useGeneratedKeys="true"
            keyProperty="attachmentId"
            keyColumn="attachment_id">
        INSERT INTO attachments (
            board_id
           ,file_name
           ,file_path
           ,content_type
           ,code_type
           ,code_value
           ,created_by
           ,created_at
           ,updated_by
           ,updated_at
           ,is_display
        )
        VALUES (
            #{reviewId}
           ,#{fileName}
           ,#{filePath}
           ,#{fileType}
           ,'002'
           ,1
           ,#{createdBy}
           ,#{createdAt}
           ,#{createdBy}
           ,#{createdAt}
           ,1
        )
    </insert>

    <!-- 画像IDでレビュー添付ファイルを削除（論理的に非表示化） -->
    <delete id="deleteReviewAttachment" parameterType="map">
        UPDATE attachments
        SET    is_display = 0
              ,updated_at = NOW()
        WHERE  board_id      = #{reviewId}
          AND  attachment_id = #{imageId}
    </delete>

    <!-- レビュー閲覧数増加 -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE reviews
        SET    view_count = COALESCE(view_count, 0) + 1
              ,updated_at = NOW()
        WHERE  review_id   = #{reviewId, jdbcType=BIGINT}
          AND  is_display = '1'
    </update>

    <!-- レビュー全体更新 -->
    <update id="updateReview" parameterType="map">
        UPDATE reviews
        SET    title         = COALESCE(#{review.title},        title)
              ,content       = COALESCE(#{review.content},      content)
              ,review_type   = COALESCE(CAST(#{review.reviewType} AS VARCHAR), review_type)
              ,product_id    = COALESCE(#{review.productId},    product_id)
              ,product_code  = COALESCE(#{review.productCode},  product_code)
              ,member_number = COALESCE(#{review.memberNumber}, member_number)
              ,order_number  = COALESCE(#{review.orderNumber},  order_number)
              ,updated_by    = COALESCE(#{review.updatedBy},    updated_by)
              ,updated_at    = NOW()
        WHERE  review_id    = #{reviewId}
          AND  is_display   = '1'
          AND  member_number = COALESCE(
                (SELECT u.member_number
                 FROM users u
                 WHERE u.user_id = CAST(#{review.userId, jdbcType=BIGINT} AS BIGINT)
                 LIMIT 1),
                member_number
          )
    </update>

</mapper>
