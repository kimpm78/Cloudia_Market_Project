<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_04_1000.mapper.CM041000Mapper">

    <!-- 리뷰 하드 삭제 -->
    <delete id="deleteReview" parameterType="map">
        DELETE FROM reviews
        WHERE review_id = #{reviewId}
          AND user_id   = #{userId}
    </delete>

    <!-- 리뷰 내용 수정 -->
    <update id="updateReviewContent" parameterType="map">
        UPDATE reviews
        SET    content    = #{content}
              ,updated_by = COALESCE(#{updatedBy}, updated_by)
              ,updated_at = NOW()
        WHERE  review_id  = #{reviewId}
          AND  delete_flag = 0
    </update>

    <!-- 리뷰 메인 이미지 업데이트 -->
    <update id="updateReviewImage" parameterType="map">
        UPDATE reviews
        SET    image_url  = #{imageUrl}
              ,updated_at = NOW()
        WHERE  review_id  = #{reviewId}
          AND  delete_flag = 0
    </update>

    <!-- 리뷰 목록 조회 (productId가 없으면 전체 조회) -->
    <select id="selectReviews"
            parameterType="map"
            resultType="com.cloudia.backend.CM_04_1000.model.ReviewInfo">
        SELECT r.review_id  AS reviewId
              ,r.user_id    AS userId
              ,r.product_id AS productId
              ,r.review_type AS reviewType
              ,r.title      AS title
              ,r.image_url  AS imageUrl
              ,r.content    AS content
              ,r.view_count AS viewCount
              ,r.created_by AS createdBy
              ,r.created_at AS createdAt
              ,r.updated_at AS updatedAt
              ,NULLIF(SUBSTRING(r.content FROM 1 FOR 100), '') AS summary
          FROM reviews r
         WHERE r.delete_flag = 0
        <if test="productId != null">
           AND r.product_id = #{productId}
        </if>
         ORDER BY r.created_at DESC
                 ,r.review_id  DESC
        <if test="size != null and offset != null">
           LIMIT  #{size}
          OFFSET  #{offset}
        </if>
    </select>

    <!-- 리뷰 작성 -->
    <insert id="writeReview"
            parameterType="com.cloudia.backend.CM_04_1000.model.ReviewRequest"
            useGeneratedKeys="true"
            keyProperty="reviewId"
            keyColumn="review_id">
        INSERT INTO reviews (
            user_id
           ,member_number
           ,order_number
           ,product_id
           ,product_code
           ,review_type
           ,title
           ,image_url
           ,content
           ,view_count
           ,delete_flag
           ,created_by
           ,created_at
           ,updated_by
           ,updated_at
        )
        VALUES (
            #{userId}
           ,#{memberNumber}
           ,#{orderNumber}
           ,#{productId}
           ,#{productCode}
           ,#{reviewType}
           ,#{title}
           ,#{imageUrl}
           ,#{content}
           ,0
           ,0
           ,#{createdBy}
           ,NOW()
           ,#{createdBy}
           ,NOW()
        )
        RETURNING review_id
    </insert>

    <!-- 리뷰 상세 조회 -->
    <select id="selectReviewById"
            parameterType="long"
            resultType="com.cloudia.backend.CM_04_1000.model.ReviewInfo">
        SELECT r.review_id   AS reviewId
              ,r.user_id     AS userId
              ,r.product_id  AS productId
              ,r.review_type AS reviewType
              ,r.title       AS title
              ,r.image_url   AS imageUrl
              ,r.content     AS content
              ,r.view_count  AS viewCount
              ,r.created_by  AS createdBy
              ,r.created_at  AS createdAt
              ,r.updated_by  AS updatedBy
              ,r.updated_at  AS updatedAt
              ,(
                    SELECT COUNT(1)
                      FROM comments c
                     WHERE CAST(c.post_id AS bigint) = r.review_id
                       AND c.is_active = 1
               ) AS commentCount
          FROM reviews r
         WHERE r.review_id   = #{reviewId, jdbcType=BIGINT}
           AND r.delete_flag = 0
    </select>

    <!-- 주문과 연관된 상품 정보를 포함한 결과 매핑 -->
    <resultMap id="OrderWithProductsMap" type="com.cloudia.backend.CM_04_1000.model.OrderDetailResponse">
        <id     property="orderId"      column="orderId"/>
        <result property="memberNumber" column="memberNumber"/>
        <result property="orderNumber"  column="orderNumber"/>
        <result property="orderDate"    column="orderDate"/>
        <collection property="products" ofType="com.cloudia.backend.CM_04_1000.model.ProductInfo">
            <result property="productCode" column="productCode"/>
            <result property="productId"   column="productId"/>
            <result property="productName" column="productName"/>
        </collection>
    </resultMap>

    <!-- 주문과 상품 정보를 함께 조회 -->
    <select id="selectOrdersWithProducts"
            resultMap="OrderWithProductsMap"
            parameterType="string">
        SELECT o.order_id      AS orderId
              ,o.member_number AS memberNumber
              ,o.order_number  AS orderNumber
              ,o.order_date    AS orderDate
              ,p.product_id    AS productId
              ,p.product_code  AS productCode
              ,p.name          AS productName
          FROM orders o
          JOIN order_details d
            ON o.member_number = d.member_number
           AND o.order_number  = d.order_number
          JOIN products p
            ON p.product_code  = d.product_id
         WHERE o.member_number = #{memberNumber}
         ORDER BY o.order_date ASC
    </select>

    <!-- 리뷰 작성 전 구매 내역 확인 -->
    <select id="checkOrderProduct"
            parameterType="map"
            resultType="int">
        SELECT COUNT(1)
          FROM orders o
          JOIN order_details od
            ON o.member_number = od.member_number
           AND o.order_number  = od.order_number
          JOIN products p
            ON p.product_code  = od.product_id
         WHERE o.member_number = #{memberNumber}
           AND o.order_number  = #{orderNumber}
           AND p.product_code  = #{productCode}
    </select>

    <!-- 상품 코드로 상품 ID 조회 -->
    <select id="findProductIdByCode"
            parameterType="string"
            resultType="long">
        SELECT product_id
          FROM products
         WHERE product_code = #{productCode}
         LIMIT 1
    </select>

    <!-- 리뷰 첨부파일 삽입 -->
    <insert id="insertReviewAttachment"
            parameterType="com.cloudia.backend.CM_04_1000.model.Attachments"
            useGeneratedKeys="true"
            keyProperty="attachmentId"
            keyColumn="attachment_id">
        INSERT INTO attachments (
            board_id
           ,file_name
           ,file_path
           ,content_type
           ,code_type
           ,code_value
           ,created_by
           ,created_at
           ,updated_by
           ,updated_at
           ,is_display
        )
        VALUES (
            #{reviewId}
           ,#{fileName}
           ,#{filePath}
           ,#{fileType}
           ,'002'
           ,1
           ,#{createdBy}
           ,#{createdAt}
           ,#{createdBy}
           ,#{createdAt}
           ,1
        )
    </insert>

    <!-- 이미지 ID로 리뷰 첨부파일 삭제 (논리 비표시) -->
    <delete id="deleteReviewAttachment" parameterType="map">
        UPDATE attachments
        SET    is_display = 0
              ,updated_at = NOW()
        WHERE  board_id      = #{reviewId}
          AND  attachment_id = #{imageId}
    </delete>

    <!-- 리뷰 조회수 증가 -->
    <update id="incrementViewCount" parameterType="long">
        UPDATE reviews
        SET    view_count = COALESCE(view_count, 0) + 1
              ,updated_at = NOW()
        WHERE  review_id   = #{reviewId, jdbcType=BIGINT}
          AND  delete_flag = 0
    </update>

    <!-- 리뷰 전체 수정 -->
    <update id="updateReview" parameterType="map">
        UPDATE reviews
        SET    title         = COALESCE(#{review.title},        title)
              ,content       = COALESCE(#{review.content},      content)
              ,review_type   = COALESCE(#{review.reviewType},   review_type)
              ,product_id    = COALESCE(#{review.productId},    product_id)
              ,product_code  = COALESCE(#{review.productCode},  product_code)
              ,member_number = COALESCE(#{review.memberNumber}, member_number)
              ,order_number  = COALESCE(#{review.orderNumber},  order_number)
              ,updated_by    = COALESCE(#{review.updatedBy},    updated_by)
              ,updated_at    = NOW()
        WHERE  review_id    = #{reviewId}
          AND  delete_flag  = 0
          AND  user_id      = COALESCE(#{review.userId, jdbcType=BIGINT}, user_id)
    </update>

</mapper>
