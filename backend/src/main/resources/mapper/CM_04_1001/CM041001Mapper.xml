<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_04_1001.mapper.CM041001Mapper">


  <!-- 댓글/대댓글 평탄 목록 조회 (트리 변환용) - 루트 먼저, 같은 부모끼리 시간순 -->
  <select id="selectCommentsByReviewId"
          parameterType="java.lang.Long"
          resultType="com.cloudia.backend.CM_04_1001.model.ReviewCommentInfo">
    SELECT
      c.comment_id         AS commentId,
      c.post_id            AS reviewId,
      c.parent_id          AS parentCommentId,
      c.user_id            AS userId,
      u.login_id           AS userName,
      c.content            AS content,
      CASE WHEN c.is_active = 1 THEN 0 ELSE 1 END AS deleteFlag,
      c.created_by         AS createdBy,
      c.created_at         AS createdAt,
      c.updated_by         AS updatedBy,
      c.updated_at         AS updatedAt
    FROM comments c
    JOIN users u ON CAST(c.user_id AS bigint) = u.user_id
    WHERE CAST(c.post_id AS bigint) = #{reviewId}
      AND c.is_active = 1
    ORDER BY
      COALESCE(c.group_id, c.comment_id),
      CASE WHEN c.parent_id IS NULL THEN 0 ELSE 1 END,
      c.sort_order,
      c.created_at,
      c.comment_id
  </select>

  <!-- 부모 댓글 존재 여부 확인 -->
  <select id="existsComment" parameterType="java.lang.Long" resultType="int">
    SELECT COUNT(1)
    FROM comments
    WHERE comment_id = #{commentId}
      AND is_active = 1
  </select>

  <!-- 댓글 작성자 조회 -->
  <select id="findCommentOwnerId" parameterType="java.lang.Long" resultType="long">
    SELECT user_id
    FROM comments
    WHERE comment_id = #{commentId}
      AND is_active = 1
    LIMIT 1
  </select>

  <!-- 댓글/대댓글 등록 (parentCommentId가 null이면 댓글, 값이 있으면 대댓글) -->
  <insert id="insertComment"
    parameterType="com.cloudia.backend.CM_04_1001.model.ReviewCommentRequest"
    useGeneratedKeys="true" keyProperty="commentId" keyColumn="comment_id">
    INSERT INTO comments (
      post_id,
      parent_id,
      user_id,
      content,
      depth,
      group_id,
      sort_order,
      is_active,
      created_by,
      created_at
    )
    VALUES (
      #{reviewId},
      #{parentCommentId,jdbcType=BIGINT},
      #{userId},
      #{content},
      CASE WHEN #{parentCommentId,jdbcType=BIGINT} IS NULL THEN 0 ELSE 1 END,
      CASE
        WHEN #{parentCommentId,jdbcType=BIGINT} IS NULL THEN NULL
        ELSE (SELECT group_id FROM comments WHERE comment_id = #{parentCommentId} LIMIT 1)
      END,
      CASE
        WHEN #{parentCommentId,jdbcType=BIGINT} IS NULL THEN 0
        ELSE COALESCE((
          SELECT MAX(sort_order)
            FROM comments
           WHERE group_id = (
             SELECT group_id FROM comments WHERE comment_id = #{parentCommentId} LIMIT 1
           )
        ), 0) + 1
      END,
      1,
      #{createdBy},
      NOW()
    )
  </insert>

  <!-- 루트 댓글은 group_id를 자기 comment_id로 세팅 -->
  <update id="updateRootGroupId" parameterType="long">
    UPDATE comments
    SET group_id = comment_id
    WHERE comment_id = #{commentId}
  </update>

  <!-- 댓글 논리 수정 (작성자 본인만) -->
  <update id="updateComment">
    UPDATE comments
    SET content = #{content},
        updated_by = #{userId},
        updated_at = NOW()
    WHERE comment_id = #{commentId}
      AND CAST(user_id AS bigint) = #{userId}
      AND is_active = 1
  </update>

  <!-- 댓글 논리 삭제 (작성자 본인만) -->
  <update id="softDeleteComment">
    UPDATE comments
    SET is_active = 0, updated_at = NOW()
    WHERE CAST(post_id AS bigint) = #{reviewId}
      AND comment_id = #{commentId}
      AND CAST(user_id AS bigint) = #{userId}
  </update>

  <!-- 특정 리뷰의 댓글/대댓글 모두 하드 삭제 -->
  <delete id="deleteCommentsByReviewId" parameterType="long">
    DELETE FROM comments
    WHERE CAST(post_id AS bigint) = #{reviewId}
  </delete>

</mapper>
