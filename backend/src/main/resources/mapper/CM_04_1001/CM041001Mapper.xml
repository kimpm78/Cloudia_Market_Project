<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_04_1001.mapper.CM041001Mapper">

  <!-- レビューIDでコメント/返信のフラット一覧を取得（サービス層でツリー化） -->
  <select id="selectCommentsByReviewId"
          parameterType="java.lang.Long"
          resultType="com.cloudia.backend.CM_04_1001.model.ReviewCommentInfo">
    SELECT
      rc.comment_id        AS commentId,
      rc.review_id         AS reviewId,
      rc.parent_comment_id AS parentCommentId,
      u.user_id            AS userId,
      u.login_id           AS userName,
      rc.content           AS content,
      CASE WHEN rc.is_display = '1' THEN 0 ELSE 1 END AS deleteFlag,
      rc.created_by        AS createdBy,
      rc.created_at        AS createdAt,
      rc.updated_by        AS updatedBy,
      rc.updated_at        AS updatedAt
    FROM review_comments rc
    LEFT JOIN users u
      ON u.member_number = rc.member_number
    WHERE rc.review_id = #{reviewId}
      AND rc.is_display = '1'
    ORDER BY
      CASE WHEN rc.parent_comment_id IS NULL THEN 0 ELSE 1 END,
      COALESCE(rc.parent_comment_id, rc.comment_id),
      rc.created_at,
      rc.comment_id
  </select>

  <!-- 親コメントが有効状態で存在するか確認 -->
  <select id="existsComment" parameterType="java.lang.Long" resultType="int">
    SELECT COUNT(1)
    FROM review_comments
    WHERE comment_id = #{commentId}
      AND is_display = '1'
  </select>

  <!-- コメント作成者のuser_idを取得 -->
  <select id="findCommentOwnerId" parameterType="java.lang.Long" resultType="long">
    SELECT u.user_id
    FROM review_comments rc
    JOIN users u
      ON u.member_number = rc.member_number
    WHERE rc.comment_id = #{commentId}
      AND rc.is_display = '1'
    LIMIT 1
  </select>

  <!-- コメント/返信の登録 -->
  <insert id="insertComment"
    parameterType="com.cloudia.backend.CM_04_1001.model.ReviewCommentRequest"
    useGeneratedKeys="true" keyProperty="commentId" keyColumn="comment_id">
    INSERT INTO review_comments (
      review_id,
      parent_comment_id,
      member_number,
      content,
      is_display,
      created_by,
      created_at,
      updated_by,
      updated_at
    )
    VALUES (
      #{reviewId},
      #{parentCommentId,jdbcType=BIGINT},
      (
        SELECT member_number
        FROM users
        WHERE user_id = CAST(#{userId} AS BIGINT)
        LIMIT 1
      ),
      #{content},
      '1',
      COALESCE(
        #{createdBy},
        (
          SELECT login_id
          FROM users
          WHERE user_id = CAST(#{userId} AS BIGINT)
          LIMIT 1
        )
      ),
      NOW(),
      COALESCE(
        #{createdBy},
        (
          SELECT login_id
          FROM users
          WHERE user_id = CAST(#{userId} AS BIGINT)
          LIMIT 1
        )
      ),
      NOW()
    )
  </insert>

  <!-- 既存サービス呼び出し互換のためのダミー更新（group_id非使用） -->
  <update id="updateRootGroupId" parameterType="long">
    UPDATE review_comments
    SET updated_at = updated_at
    WHERE comment_id = #{commentId}
  </update>

  <!-- コメント更新（本人のみ） -->
  <update id="updateComment">
    UPDATE review_comments
    SET content = #{content},
        updated_by = COALESCE(
          (
            SELECT login_id
            FROM users
            WHERE user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
          ),
          updated_by
        ),
        updated_at = NOW()
    WHERE comment_id = #{commentId}
      AND member_number = (
        SELECT member_number
        FROM users
        WHERE user_id = CAST(#{userId} AS BIGINT)
        LIMIT 1
      )
      AND is_display = '1'
  </update>

  <!-- コメント論理削除（本人のみ） -->
  <update id="softDeleteComment">
    UPDATE review_comments
    SET is_display = '0',
        updated_by = COALESCE(
          (
            SELECT login_id
            FROM users
            WHERE user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
          ),
          updated_by
        ),
        updated_at = NOW()
    WHERE review_id = #{reviewId}
      AND comment_id = #{commentId}
      AND member_number = (
        SELECT member_number
        FROM users
        WHERE user_id = CAST(#{userId} AS BIGINT)
        LIMIT 1
      )
      AND is_display = '1'
  </update>

  <!-- 指定レビュー配下のコメント/返信を物理削除 -->
  <delete id="deleteCommentsByReviewId" parameterType="long">
    DELETE FROM review_comments
    WHERE review_id = #{reviewId}
  </delete>

</mapper>
