<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_06_1000.mapper.CM061000Mapper">

    <!-- TTL（カート予約の有効時間） -->
    <sql id="CartReservationTtlClause">
        ci.is_display = '1'
        AND ci.cart_updated_at >= (NOW() - INTERVAL '30 minutes')
    </sql>

    <!-- CartItemエンティティのカラムマッピング -->
    <sql id="CartItemColumns">
        cart_item_id    AS cartItemId,
        (
            SELECT u.user_id
            FROM users u
            WHERE u.member_number = cart_items.member_number
            LIMIT 1
        )               AS userId,
        product_code    AS productId,
        quantity        AS quantity,
        CASE WHEN is_display = '1' THEN 1 ELSE 0 END AS isActive,
        cart_updated_at AS cartUpdatedAt,
        created_by      AS createdBy,
        created_at      AS createdAt,
        updated_by      AS UpdatedBy,
        updated_at      AS updatedAt
    </sql>

    <!-- カート + 商品 + 画像 + 在庫（予約反映）取得ベース -->
    <sql id="CartItemBaseSelect">
        SELECT ci.cart_item_id  AS cartItemId
              ,COALESCE(p.product_code, ci.product_code) AS productId
              ,p.title            AS productName
              ,p.price            AS productPrice
              ,pd.thumbnail_url   AS imageLink
              ,ci.quantity        AS quantity
              ,(p.price * ci.quantity) AS lineTotal
              ,0                  AS shippingFee
              ,p.purchaselimit    AS purchaseLimit
              ,GREATEST(
                    0,
                    COALESCE(s.available_qty, 0) + COALESCE(ci.quantity, 0)
               ) AS availableQty
              ,ci.cart_updated_at AS cartUpdatedAt
              ,ROW_NUMBER() OVER (
                  PARTITION BY ci.cart_item_id
                  ORDER BY ci.cart_updated_at DESC
               ) AS rn
        FROM   cart_items ci
        LEFT JOIN LATERAL (
            SELECT p.product_id
                  ,p.product_code
                  ,p.title
                  ,p.price
                  ,p.purchaselimit
            FROM   products p
            WHERE  p.product_code = ci.product_code
            ORDER BY 
                   p.updated_at DESC NULLS LAST
                  ,p.product_id DESC
            LIMIT 1
        ) p ON TRUE
        LEFT JOIN LATERAL (
            SELECT pd.thumbnail_url
            FROM   product_details pd
            WHERE  pd.product_id = p.product_id
            ORDER BY 
                   pd.updated_at DESC NULLS LAST
                  ,pd.product_detail_id DESC
            LIMIT 1
        ) pd ON TRUE
        LEFT JOIN (
            SELECT product_code
                  ,available_qty
            FROM  (
                SELECT s1.product_code
                      ,s1.available_qty
                      ,ROW_NUMBER() OVER (
                          PARTITION BY s1.product_code
                          ORDER BY s1.updated_at DESC NULLS LAST
                      ) AS rn
                FROM   stocks s1
            ) ranked
            WHERE rn = 1
        ) s
        ON    s.product_code = COALESCE(p.product_code, ci.product_code)
    </sql>

    <!-- 最新在庫行ロック（同時カート投入の競合防止） -->
    <select id="lockLatestStockRow" parameterType="string" resultType="long">
        SELECT s.stock_id
        FROM   stocks s
        WHERE  s.product_code = #{productId}
        ORDER BY s.updated_at DESC NULLS LAST
        LIMIT 1
        FOR UPDATE
    </select>

    <!-- ユーザー基準の最大投入可能数量（有効在庫 + 自分の予約分） -->
    <select id="findMaxPurchasableQuantity" resultType="java.lang.Integer">
        SELECT GREATEST(
            0,
            COALESCE(stock.available_qty, 0)
            + COALESCE(my.my_qty, 0)
        ) AS max_qty
        FROM (
            SELECT COALESCE((
                SELECT s.available_qty
                FROM   stocks s
                WHERE  s.product_code = #{productId}
                ORDER BY s.updated_at DESC NULLS LAST
                LIMIT 1
            ), 0) AS available_qty
        ) stock
        LEFT JOIN (
            SELECT SUM(ci.quantity) AS my_qty
            FROM   cart_items ci
            WHERE  ci.member_number = (
                      SELECT u.member_number
                      FROM users u
                      WHERE u.user_id = CAST(#{userId} AS BIGINT)
                      LIMIT 1
                   )
              AND  ci.product_code = #{productId}
              AND  <include refid="CartReservationTtlClause" />
        ) my ON TRUE
    </select>

    <!-- カート一覧取得 -->
    <select id="findCartByUser" resultType="com.cloudia.backend.CM_06_1000.model.CartItemResponse">
        SELECT cartItemId
              ,productId
              ,productName
              ,productPrice
              ,imageLink
              ,quantity
              ,lineTotal
              ,shippingFee
              ,availableQty
              ,purchaseLimit
        FROM (
            <include refid="CartItemBaseSelect" />
            WHERE ci.member_number = (
                      SELECT u.member_number
                      FROM users u
                      WHERE u.user_id = CAST(#{userId} AS BIGINT)
                      LIMIT 1
                  )
            AND   ci.is_display = '1'
        ) dedup
        WHERE rn = 1
        ORDER BY 
               cartUpdatedAt DESC
    </select>

    <!-- カート投入検証用：現在のカート商品メタ取得 -->
    <select id="findActiveCartProductMetas" resultType="com.cloudia.backend.CM_06_1000.model.CartProductMeta">
        SELECT DISTINCT
            ci.product_code AS productId,
            CASE
                WHEN COALESCE(p.release_date, p.reservation_deadline) IS NULL THEN NULL
                ELSE LEFT(CAST(COALESCE(p.release_date, p.reservation_deadline) AS VARCHAR), 7)
            END AS releaseMonth,
            CASE
                WHEN p.code_value IN (3, 4) THEN TRUE
                WHEN p.code_value IS NOT NULL THEN FALSE
                WHEN p.reservation_deadline IS NULL THEN FALSE
                ELSE TRUE
            END AS reservation,
            p.purchaselimit AS purchaseLimit
        FROM cart_items ci
        LEFT JOIN products p
          ON (
            CAST(p.product_id AS VARCHAR) = ci.product_code
            OR p.product_code = ci.product_code
          )
        WHERE ci.member_number = (
                SELECT u.member_number
                FROM users u
                WHERE u.user_id = CAST(#{userId} AS BIGINT)
                LIMIT 1
            )
          AND <include refid="CartReservationTtlClause" />
    </select>

    <!-- カート投入検証用：対象商品メタ取得 -->
    <select id="findProductCartMeta" resultType="com.cloudia.backend.CM_06_1000.model.CartProductMeta">
        SELECT
            COALESCE(p.product_code, CAST(p.product_id AS VARCHAR)) AS productId,
            CASE
                WHEN COALESCE(p.release_date, p.reservation_deadline) IS NULL THEN NULL
                ELSE LEFT(CAST(COALESCE(p.release_date, p.reservation_deadline) AS VARCHAR), 7)
            END AS releaseMonth,
            CASE
                WHEN p.code_value IN (3, 4) THEN TRUE
                WHEN p.code_value IS NOT NULL THEN FALSE
                WHEN p.reservation_deadline IS NULL THEN FALSE
                ELSE TRUE
            END AS reservation,
            p.purchaselimit AS purchaseLimit
        FROM products p
        WHERE p.product_code = #{productId}
           OR CAST(p.product_id AS VARCHAR) = #{productId}
        ORDER BY p.updated_at DESC NULLS LAST, p.product_id DESC
        LIMIT 1
    </select>

    <!-- 同一商品の存在有無（有効） -->
    <select id="findActiveCartItem" parameterType="map" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  member_number = (
                  SELECT u.member_number
                  FROM users u
                  WHERE u.user_id = CAST(#{userId} AS BIGINT)
                  LIMIT 1
               )
        AND    product_code = CAST(#{productId} AS VARCHAR)
        AND    is_display   = '1'
        LIMIT 1
    </select>

    <!-- 新規追加 -->
    <insert id="insertCartItem" parameterType="com.cloudia.backend.CM_06_1000.model.CartItem" useGeneratedKeys="true" keyProperty="cartItemId" keyColumn="cart_item_id">
        INSERT INTO cart_items (
               member_number
              ,product_code
              ,quantity
              ,cart_updated_at
              ,is_display
              ,created_by
              ,created_at
              ,updated_by
              ,updated_at
        ) VALUES (
               (
                   SELECT u.member_number
                   FROM users u
                   WHERE u.user_id = CAST(#{userId, jdbcType=BIGINT} AS BIGINT)
                   LIMIT 1
               )
              ,#{productId, jdbcType=VARCHAR}
              ,#{quantity}
              ,NOW()
              ,'1'
              ,#{createdBy}
              ,NOW()
              ,#{updatedBy}
              ,NOW()
        )
    </insert>

    <!-- 数量加算 -->
    <update id="increaseQuantity" parameterType="map">
        UPDATE cart_items
        SET    quantity       = quantity + #{addQty}
              ,cart_updated_at = NOW()
              ,updated_by      = #{updatedBy}
              ,updated_at      = NOW()
        WHERE  cart_item_id   = #{cartItemId}
        AND    is_display     = '1'
    </update>

    <!-- 数量の絶対値更新 -->
    <update id="updateQuantity" parameterType="map">
        UPDATE cart_items
        SET    quantity        = #{quantity}
              ,cart_updated_at = NOW()
              ,updated_by      = #{updatedBy}
              ,updated_at      = NOW()
        WHERE  cart_item_id    = #{cartItemId}
        AND    is_display      = '1'
    </update>

    <!-- カート予約数量増加（在庫減算） -->
    <update id="increaseCartReservation" parameterType="map">
        UPDATE stocks
        SET    available_qty = available_qty - #{quantity},
               cart_qty      = COALESCE(cart_qty, 0) + #{quantity},
               updated_at    = NOW()
        WHERE  stock_id = (
            SELECT s.stock_id
            FROM   stocks s
            WHERE  s.product_code = #{productId}
            ORDER BY s.updated_at DESC NULLS LAST
            LIMIT 1
        )
        AND    available_qty >= #{quantity}
    </update>

    <!-- カート予約数量減少（在庫復元） -->
    <update id="decreaseCartReservation" parameterType="map">
        UPDATE stocks
        SET    available_qty = available_qty + #{quantity},
               cart_qty      = GREATEST(COALESCE(cart_qty, 0) - #{quantity}, 0),
               updated_at    = NOW()
        WHERE  stock_id = (
            SELECT s.stock_id
            FROM   stocks s
            WHERE  s.product_code = #{productId}
            ORDER BY s.updated_at DESC NULLS LAST
            LIMIT 1
        )
    </update>

    <!-- カートのソフト削除 -->
    <update id="softDelete" parameterType="map">
        UPDATE cart_items
        SET    is_display = '0',
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE  cart_item_id = #{cartItemId}
    </update>

    <!-- 選択したカート項目のソフト削除 -->
    <update id="softDeleteSelected" parameterType="map">
        UPDATE cart_items
        SET    is_display = '0',
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE  member_number = (
                  SELECT u.member_number
                  FROM users u
                  WHERE u.user_id = CAST(#{userId} AS BIGINT)
                  LIMIT 1
               )
        AND    cart_item_id IN
          <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
        AND    is_display = '1'
    </update>

    <!-- cart_item_idで単一項目取得 -->
    <select id="findCartItemById" parameterType="long" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  cart_item_id = #{cartItemId}
        AND    is_display   = '1'
        LIMIT 1
    </select>

    <!-- ユーザーの有効カート項目取得 -->
    <select id="findActiveCartItemsByUser" parameterType="long" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            ci.cart_item_id AS cartItemId,
            CAST(#{userId} AS BIGINT) AS userId,
            ci.product_code AS productId,
            ci.quantity AS quantity,
            CASE WHEN ci.is_display = '1' THEN 1 ELSE 0 END AS isActive,
            ci.cart_updated_at AS cartUpdatedAt,
            ci.created_by AS createdBy,
            ci.created_at AS createdAt,
            ci.updated_by AS updatedBy,
            ci.updated_at AS updatedAt
        FROM cart_items ci
        WHERE ci.member_number = (
            SELECT u.member_number
            FROM users u
            WHERE u.user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
        )
        AND ci.is_display = '1'
    </select>

    <!-- 選択したカート項目取得 -->
    <select id="findActiveCartItemsByIds" parameterType="map" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  member_number = (
                  SELECT u.member_number
                  FROM users u
                  WHERE u.user_id = CAST(#{userId} AS BIGINT)
                  LIMIT 1
               )
        AND    is_display = '1'
        AND    cart_item_id IN
          <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <!-- ユーザーのカート初回作成日時（TTL基準） -->
    <select id="findCartCreatedAt" parameterType="long" resultType="java.time.LocalDateTime">
        SELECT MIN(ci.created_at)
        FROM cart_items ci
        WHERE ci.member_number = (
            SELECT u.member_number
            FROM users u
            WHERE u.user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
        )
        AND ci.is_display = '1'
    </select>

    <!-- 直近更新日時が必要な場合に備えたクエリ -->
    <select id="findLastUpdatedAt" parameterType="long" resultType="java.time.LocalDateTime">
        SELECT MAX(ci.cart_updated_at)
        FROM cart_items ci
        WHERE ci.member_number = (
            SELECT u.member_number
            FROM users u
            WHERE u.user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
        )
        AND ci.is_display = '1'
    </select>

    <!-- カート期限切れ処理 -->
    <update id="expireCartByUser" parameterType="map">
        UPDATE cart_items
        SET    is_display = '0',
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE member_number = (
            SELECT u.member_number
            FROM users u
            WHERE u.user_id = CAST(#{userId} AS BIGINT)
            LIMIT 1
        )
        AND is_display = '1'
    </update>

    <!-- 注文準備用の選択項目取得 -->
    <select id="findSelectedForOrder" resultType="com.cloudia.backend.CM_06_1000.model.CartItemResponse">
        SELECT cartItemId
              ,productId
              ,productName
              ,productPrice
              ,imageLink
              ,quantity
              ,lineTotal
              ,shippingFee
              ,availableQty
              ,purchaseLimit
        FROM (
            <include refid="CartItemBaseSelect" />
            WHERE ci.member_number = (
                      SELECT u.member_number
                      FROM users u
                      WHERE u.user_id = CAST(#{userId} AS BIGINT)
                      LIMIT 1
                  )
            AND   ci.is_display = '1'
            AND   ci.cart_item_id IN
              <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
                  #{id}
              </foreach>
        ) dedup
        WHERE rn = 1
        ORDER BY 
               cartUpdatedAt DESC
    </select>

    <!-- 商品識別子の標準化 -->
    <select id="findCanonicalProductId" parameterType="string" resultType="string">
        SELECT COALESCE(p.product_code, CAST(p.product_id AS VARCHAR)) AS canonical_id
        FROM   products p
        WHERE  CAST(p.product_id AS VARCHAR) = #{productId}
        OR     p.product_code = #{productId}
        LIMIT 1
    </select>

</mapper>
