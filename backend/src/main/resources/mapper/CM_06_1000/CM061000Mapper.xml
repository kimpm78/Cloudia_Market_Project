<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_06_1000.mapper.CM061000Mapper">

    <!-- TTL(장바구니 예약 유효 시간) -->
    <sql id="CartReservationTtlClause">
        ci.is_active = 1
        AND ci.cart_updated_at >= (NOW() - INTERVAL '30 minutes')
    </sql>

    <!-- CartItem 엔티티 컬럼 매핑 -->
    <sql id="CartItemColumns">
        cart_item_id    AS cartItemId,
        user_id         AS userId,
        product_id      AS productId,
        quantity        AS quantity,
        is_active       AS isActive,
        cart_updated_at AS cartUpdatedAt,
        created_by      AS createdBy,
        created_at      AS createdAt,
        updated_by      AS UpdatedBy,
        updated_at      AS updatedAt
    </sql>

    <!-- 장바구니 + 상품 + 이미지 + 재고(예약 반영) 조회 베이스 -->
    <sql id="CartItemBaseSelect">
        SELECT ci.cart_item_id  AS cartItemId
              ,COALESCE(p.product_code, ci.product_id) AS productId
              ,p.name             AS productName
              ,p.price            AS productPrice
              ,pd.thumbnail_url   AS imageLink
              ,ci.quantity        AS quantity
              ,(p.price * ci.quantity) AS lineTotal
              ,p.delivery_price   AS shippingFee
              ,p.purchaseLimit    AS purchaseLimit
              ,GREATEST(
                    0,
                    COALESCE(s.available_qty, 0) + COALESCE(ci.quantity, 0)
               ) AS availableQty
              ,ci.cart_updated_at AS cartUpdatedAt
              ,ROW_NUMBER() OVER (
                  PARTITION BY ci.cart_item_id
                  ORDER BY ci.cart_updated_at DESC
               ) AS rn
        FROM   cart_items ci
        LEFT JOIN LATERAL (
            SELECT p.product_id
                  ,p.product_code
                  ,p.name
                  ,p.price
                  ,p.delivery_price
                  ,p.purchaseLimit
            FROM   products p
            WHERE  p.product_code = ci.product_id
            ORDER BY 
                   p.updated_at DESC NULLS LAST
                  ,p.product_id DESC
            LIMIT 1
        ) p ON TRUE
        LEFT JOIN LATERAL (
            SELECT pd.thumbnail_url
            FROM   product_details pd
            WHERE  pd.product_id = p.product_id
            ORDER BY 
                   pd.updated_at DESC NULLS LAST
                  ,pd.product_detail_id DESC
            LIMIT 1
        ) pd ON TRUE
        LEFT JOIN (
            SELECT product_code
                  ,available_qty
            FROM  (
                SELECT s1.product_code
                      ,s1.available_qty
                      ,ROW_NUMBER() OVER (
                          PARTITION BY s1.product_code
                          ORDER BY s1.updated_at DESC NULLS LAST
                      ) AS rn
                FROM   stocks s1
            ) ranked
            WHERE rn = 1
        ) s
        ON    s.product_code = COALESCE(p.product_code, ci.product_id)
    </sql>

    <!-- 최신 재고 행 잠금(동시 장바구니 담기 경쟁조건 방지) -->
    <select id="lockLatestStockRow" parameterType="string" resultType="long">
        SELECT s.stock_id
        FROM   stocks s
        WHERE  s.product_code = #{productId}
        ORDER BY s.updated_at DESC NULLS LAST
        LIMIT 1
        FOR UPDATE
    </select>

    <!-- 사용자 기준 최대 담기 가능 수량(가용재고 + 내예약) -->
    <select id="findMaxPurchasableQuantity" resultType="java.lang.Integer">
        SELECT GREATEST(
            0,
            COALESCE(stock.available_qty, 0)
            + COALESCE(my.my_qty, 0)
        ) AS max_qty
        FROM (
            SELECT COALESCE((
                SELECT s.available_qty
                FROM   stocks s
                WHERE  s.product_code = #{productId}
                ORDER BY s.updated_at DESC NULLS LAST
                LIMIT 1
            ), 0) AS available_qty
        ) stock
        LEFT JOIN (
            SELECT SUM(ci.quantity) AS my_qty
            FROM   cart_items ci
            WHERE  ci.user_id = CAST(#{userId} AS BIGINT)
              AND  ci.product_id = #{productId}
              AND  <include refid="CartReservationTtlClause" />
        ) my ON TRUE
    </select>

    <!-- 장바구니 목록 조회 -->
    <select id="findCartByUser" resultType="com.cloudia.backend.CM_06_1000.model.CartItemResponse">
        SELECT cartItemId
              ,productId
              ,productName
              ,productPrice
              ,imageLink
              ,quantity
              ,lineTotal
              ,shippingFee
              ,availableQty
              ,purchaseLimit
        FROM (
            <include refid="CartItemBaseSelect" />
            WHERE ci.user_id   = CAST(#{userId} AS BIGINT)
            AND   ci.is_active = 1
        ) dedup
        WHERE rn = 1
        ORDER BY 
               cartUpdatedAt DESC
    </select>

    <!-- 장바구니 담기 검증용: 현재 장바구니 상품 메타 조회 -->
    <select id="findActiveCartProductMetas" resultType="com.cloudia.backend.CM_06_1000.model.CartProductMeta">
        SELECT DISTINCT
            ci.product_id AS productId,
            CASE
                WHEN COALESCE(p.release_date, p.reservation_deadline) IS NULL THEN NULL
                ELSE LEFT(CAST(COALESCE(p.release_date, p.reservation_deadline) AS VARCHAR), 7)
            END AS releaseMonth,
            CASE
                WHEN p.code_value IN (3, 4) THEN TRUE
                WHEN p.code_value IS NOT NULL THEN FALSE
                WHEN p.reservation_deadline IS NULL THEN FALSE
                ELSE TRUE
            END AS reservation,
            p.purchaseLimit AS purchaseLimit
        FROM cart_items ci
        LEFT JOIN products p
          ON (
            CAST(p.product_id AS VARCHAR) = ci.product_id
            OR p.product_code = ci.product_id
          )
        WHERE ci.user_id = CAST(#{userId} AS BIGINT)
          AND <include refid="CartReservationTtlClause" />
    </select>

    <!-- 장바구니 담기 검증용: 대상 상품 메타 조회 -->
    <select id="findProductCartMeta" resultType="com.cloudia.backend.CM_06_1000.model.CartProductMeta">
        SELECT
            COALESCE(p.product_code, CAST(p.product_id AS VARCHAR)) AS productId,
            CASE
                WHEN COALESCE(p.release_date, p.reservation_deadline) IS NULL THEN NULL
                ELSE LEFT(CAST(COALESCE(p.release_date, p.reservation_deadline) AS VARCHAR), 7)
            END AS releaseMonth,
            CASE
                WHEN p.code_value IN (3, 4) THEN TRUE
                WHEN p.code_value IS NOT NULL THEN FALSE
                WHEN p.reservation_deadline IS NULL THEN FALSE
                ELSE TRUE
            END AS reservation,
            p.purchaseLimit AS purchaseLimit
        FROM products p
        WHERE p.product_code = #{productId}
           OR CAST(p.product_id AS VARCHAR) = #{productId}
        ORDER BY p.updated_at DESC NULLS LAST, p.product_id DESC
        LIMIT 1
    </select>

    <!-- 동일 상품 존재 여부 (활성) -->
    <select id="findActiveCartItem" parameterType="map" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  user_id    = CAST(#{userId} AS BIGINT)
        AND    product_id = CAST(#{productId} AS VARCHAR)
        AND    is_active  = 1
        LIMIT 1
    </select>

    <!-- 신규 추가 -->
    <insert id="insertCartItem" parameterType="com.cloudia.backend.CM_06_1000.model.CartItem" useGeneratedKeys="true" keyProperty="cartItemId" keyColumn="cart_item_id">
        INSERT INTO cart_items (
               user_id
              ,product_id
              ,quantity
              ,cart_updated_at
              ,is_active
              ,created_by
              ,created_at
              ,updated_by
              ,updated_at
        ) VALUES (
               #{userId, jdbcType=BIGINT}
              ,#{productId, jdbcType=VARCHAR}
              ,#{quantity}
              ,NOW()
              ,1
              ,#{createdBy}
              ,NOW()
              ,#{updatedBy}
              ,NOW()
        )
    </insert>

    <!-- 수량 가산 -->
    <update id="increaseQuantity" parameterType="map">
        UPDATE cart_items
        SET    quantity       = quantity + #{addQty}
              ,cart_updated_at = NOW()
              ,updated_by      = #{updatedBy}
              ,updated_at      = NOW()
        WHERE  cart_item_id   = #{cartItemId}
        AND    is_active      = 1
    </update>

    <!-- 수량 절대값 변경 -->
    <update id="updateQuantity" parameterType="map">
        UPDATE cart_items
        SET    quantity        = #{quantity}
              ,cart_updated_at = NOW()
              ,updated_by      = #{updatedBy}
              ,updated_at      = NOW()
        WHERE  cart_item_id    = #{cartItemId}
        AND    is_active       = 1
    </update>

    <!-- 장바구니 예약 수량 증가(재고 차감) -->
    <update id="increaseCartReservation" parameterType="map">
        UPDATE stocks
        SET    available_qty = available_qty - #{quantity},
               cart_qty      = COALESCE(cart_qty, 0) + #{quantity},
               updated_at    = NOW()
        WHERE  stock_id = (
            SELECT s.stock_id
            FROM   stocks s
            WHERE  s.product_code = #{productId}
            ORDER BY s.updated_at DESC NULLS LAST
            LIMIT 1
        )
        AND    available_qty >= #{quantity}
    </update>

    <!-- 장바구니 예약 수량 감소(재고 복구) -->
    <update id="decreaseCartReservation" parameterType="map">
        UPDATE stocks
        SET    available_qty = available_qty + #{quantity},
               cart_qty      = GREATEST(COALESCE(cart_qty, 0) - #{quantity}, 0),
               updated_at    = NOW()
        WHERE  stock_id = (
            SELECT s.stock_id
            FROM   stocks s
            WHERE  s.product_code = #{productId}
            ORDER BY s.updated_at DESC NULLS LAST
            LIMIT 1
        )
    </update>

    <!-- 장바구니 소프트 삭제 -->
    <update id="softDelete" parameterType="map">
        UPDATE cart_items
        SET    is_active = 0,
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE  cart_item_id = #{cartItemId}
    </update>

    <!-- 선택된 장바구니 항목 소프트 삭제 -->
    <update id="softDeleteSelected" parameterType="map">
        UPDATE cart_items
        SET    is_active  = 0,
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE  user_id = CAST(#{userId} AS BIGINT)
        AND    cart_item_id IN
          <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
        AND    is_active = 1
    </update>

    <!-- cart_item_id로 단일 항목 조회 -->
    <select id="findCartItemById" parameterType="long" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  cart_item_id = #{cartItemId}
        AND    is_active    = 1
        LIMIT 1
    </select>

    <!-- 사용자 활성 장바구니 항목 조회 -->
    <select id="findActiveCartItemsByUser" parameterType="long" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  user_id   = CAST(#{userId} AS BIGINT)
        AND    is_active = 1
    </select>

    <!-- 선택된 장바구니 항목 조회 -->
    <select id="findActiveCartItemsByIds" parameterType="map" resultType="com.cloudia.backend.CM_06_1000.model.CartItem">
        SELECT
            <include refid="CartItemColumns" />
        FROM   cart_items
        WHERE  user_id   = CAST(#{userId} AS BIGINT)
        AND    is_active = 1
        AND    cart_item_id IN
          <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <!-- 사용자 장바구니 최초 생성 시각 (TTL 기준) -->
    <select id="findCartCreatedAt" parameterType="long" resultType="java.time.LocalDateTime">
        SELECT MIN(created_at)
        FROM   cart_items
        WHERE  user_id   = CAST(#{userId} AS BIGINT)
        AND    is_active = 1
    </select>

    <!-- 최근 업데이트 일시가 필요할 경우를 대비한 쿼리 -->
    <select id="findLastUpdatedAt" parameterType="long" resultType="java.time.LocalDateTime">
        SELECT MAX(cart_updated_at)
        FROM   cart_items
        WHERE  user_id   = CAST(#{userId} AS BIGINT)
        AND    is_active = 1
    </select>

    <!-- 장바구니 만료 처리 -->
    <update id="expireCartByUser" parameterType="map">
        UPDATE cart_items
        SET    is_active = 0,
               updated_at = NOW(),
               updated_by = #{updatedBy}
        WHERE  user_id = CAST(#{userId} AS BIGINT)
    </update>

    <!-- 주문 준비용 선택 항목 조회 -->
    <select id="findSelectedForOrder" resultType="com.cloudia.backend.CM_06_1000.model.CartItemResponse">
        SELECT cartItemId
              ,productId
              ,productName
              ,productPrice
              ,imageLink
              ,quantity
              ,lineTotal
              ,shippingFee
              ,availableQty
              ,purchaseLimit
        FROM (
            <include refid="CartItemBaseSelect" />
            WHERE ci.user_id   = CAST(#{userId} AS BIGINT)
            AND   ci.is_active = 1
            AND   ci.cart_item_id IN
              <foreach collection="cartItemIds" item="id" open="(" separator="," close=")">
                  #{id}
              </foreach>
        ) dedup
        WHERE rn = 1
        ORDER BY 
               cartUpdatedAt DESC
    </select>

    <!-- 12) 상품 식별자 표준화 -->
    <select id="findCanonicalProductId" parameterType="string" resultType="string">
        SELECT COALESCE(p.product_code, CAST(p.product_id AS VARCHAR)) AS canonical_id
        FROM   products p
        WHERE  CAST(p.product_id AS VARCHAR) = #{productId}
        OR     p.product_code = #{productId}
        LIMIT 1
    </select>

</mapper>
