<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_90_1052.mapper.CM901052Mapper">
    <select id="getRefundCount" resultType="int">
        SELECT COUNT(*)
          FROM returns
         WHERE order_number = #{requestNo}
           AND member_number = #{refundNumber}
    </select>

    <select id="getOrderDetail" resultType="com.cloudia.backend.CM_90_1052.model.OrderDetailDto">
        SELECT pc.product_name
             , od.product_code AS product_id
             , od.quantity
             , od.unit_price
          FROM order_details od
     LEFT JOIN product_code pc
            ON od.product_code = pc.product_code
         WHERE member_number = #{refundNumber}
           AND order_number = #{orderNumber}
      ORDER BY product_id
    </select>

    <select id="getRefunds" resultType="com.cloudia.backend.CM_90_1052.model.ReturnsDto">
        SELECT return_id AS return_id
             , order_number AS order_no
             , order_number AS order_number
             , member_number AS customer_id
             , member_number AS member_number
             , return_status_value
             , requested_at
             , completed_at
             , reason
             , updated_by
             , updated_at
             , total_amount
             , shipping_fee_customer_amount
             , shipping_fee_seller_amount
             , refund_amount
          FROM returns
         WHERE return_status_value IN (1,2,3,4,5)
           AND COALESCE(CAST(is_display AS TEXT), '1') = '1'
    </select>

    <select id="getPeriod" resultType="com.cloudia.backend.CM_90_1052.model.ReturnsDto">
        SELECT return_id AS return_id
             , order_number AS order_no
             , order_number AS order_number
             , member_number AS customer_id
             , member_number AS member_number
             , return_status_value
             , requested_at
             , completed_at
             , reason
             , updated_by
             , updated_at
             , total_amount
             , shipping_fee_customer_amount
             , shipping_fee_seller_amount
             , refund_amount
         FROM returns
         WHERE return_status_value IN (1,2,3,4,5)
           AND COALESCE(CAST(is_display AS TEXT), '1') = '1'
           <if test="requestNo != null and requestNo != ''">
           AND CAST(order_number AS TEXT) LIKE CONCAT('%', #{requestNo}, '%')
           </if>
           AND requested_at::date <![CDATA[>=]]> #{dateFrom}::date
           AND requested_at::date <![CDATA[<=]]> #{dateTo}::date
    </select>

    <select id="getRefund" resultType="com.cloudia.backend.CM_90_1052.model.ReturnsDto">
        SELECT return_id
          FROM returns
         WHERE order_number = #{requestNo}
           AND member_number = #{refundNumber}
           AND is_display = '1'
    </select>

    <update id="updateRefund" parameterType="com.cloudia.backend.CM_90_1052.model.ReturnsDto">
        UPDATE returns
        SET    reason = #{reason}
             , total_amount = #{totalAmount}
             , refund_amount = #{refundAmount}
             , return_status_value = #{returnStatusValue}
            <if test="shippingFeeCustomerAmount neq null">
             , shipping_fee_customer_amount = #{shippingFeeCustomerAmount}
            </if>
            <if test="shippingFeeSellerAmount neq null">
             , shipping_fee_seller_amount = #{shippingFeeSellerAmount}
            </if>
             , updated_by = #{updatedBy}
             , updated_at = #{updatedAt}
        WHERE order_number = #{orderNo}
        AND   member_number = #{customerId}
        AND   is_display = '1'
    </update>

    <insert id="updateRefundDetail" parameterType="com.cloudia.backend.CM_90_1052.model.ReturnDetailsDto">
        INSERT INTO return_details (
              member_number
            , product_code
            , quantity
            , unit_price
            , is_display
            , created_by
            , created_at
            , updated_by
            , updated_at
        ) VALUES (
              (
                SELECT r.member_number
                FROM returns r
                WHERE r.return_id = #{returnId}
                LIMIT 1
              )
            , #{productCode}
            , #{quantity}
            , #{unitPrice}
            , '1'
            , #{createdBy}
            , #{createdAt}
            , #{updatedBy}
            , #{updatedAt}
        )
    </insert>
</mapper>
