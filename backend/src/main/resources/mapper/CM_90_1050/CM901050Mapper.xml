<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudia.backend.CM_90_1050.mapper.CM901050Mapper">
    <select id="findByAllSales" resultType="com.cloudia.backend.CM_90_1050.model.ResultDto">
        SELECT od.member_number AS memberNumber
              ,u.login_id AS loginId
              ,pc.product_name AS productName
              ,(
                    COALESCE(od.unit_price, 0) * COALESCE(od.quantity, 0)
                    + COALESCE(o.shipping_cost, 0)
                    - COALESCE(s.price, 0) * COALESCE(od.quantity, 0)
                    - COALESCE(o.discount_amount, 0)
               ) AS totalAmount
              ,od.unit_price AS unitPrice
              ,COALESCE(o.shipping_cost, 0) AS shippingCost
              ,COALESCE(o.discount_amount, 0) AS discountAmount
              ,COALESCE(s.price, 0) AS price
              ,COALESCE(o.order_date, o.created_at) AS orderDate
              ,od.quantity AS quantity
        FROM  orders o
        LEFT JOIN order_details od
        ON    o.member_number = od.member_number
        AND   o.order_number = od.order_number
        LEFT JOIN LATERAL (
               SELECT st.price
               FROM stocks st
               WHERE st.product_code = od.product_code
               ORDER BY st.updated_at DESC NULLS LAST
               LIMIT 1
        ) s ON TRUE
        LEFT JOIN product_code pc
        ON    od.product_code = pc.product_code
        LEFT JOIN users u
        ON    o.member_number = u.member_number              
        ORDER BY 
               od.member_number
              ,od.order_number
              ,od.order_detail_id DESC
    </select>
    <select id="getFindSales" 
            parameterType="com.cloudia.backend.CM_90_1050.model.SearchRequestDto" 
            resultType="com.cloudia.backend.CM_90_1050.model.ResultDto">
        SELECT od.member_number AS memberNumber
              ,u.login_id AS loginId
              ,pc.product_name AS productName
              ,(
                    COALESCE(od.unit_price, 0) * COALESCE(od.quantity, 0)
                    + COALESCE(o.shipping_cost, 0)
                    - COALESCE(s.price, 0) * COALESCE(od.quantity, 0)
                    - COALESCE(o.discount_amount, 0)
               ) AS totalAmount
              ,od.unit_price AS unitPrice
              ,COALESCE(o.shipping_cost, 0) AS shippingCost
              ,COALESCE(o.discount_amount, 0) AS discountAmount
              ,COALESCE(s.price, 0) AS price
              ,COALESCE(o.order_date, o.created_at) AS orderDate
              ,od.quantity AS quantity
        FROM  orders o
        LEFT JOIN order_details od
        ON    o.member_number = od.member_number
        AND   o.order_number = od.order_number
        LEFT JOIN LATERAL (
               SELECT st.price
               FROM stocks st
               WHERE st.product_code = od.product_code
               ORDER BY st.updated_at DESC NULLS LAST
               LIMIT 1
        ) s ON TRUE
        LEFT JOIN product_code pc
        ON    od.product_code = pc.product_code
        LEFT JOIN users u
        ON    o.member_number = u.member_number         
        WHERE 1=1
        <if test="dateFrom != null and dateFrom != ''">
            AND o.order_date <![CDATA[>=]]> #{dateFrom}::date
        </if>
        <if test="dateTo != null and dateTo != ''">
            AND o.order_date <![CDATA[<]]> #{dateTo}::date + INTERVAL '1 day'
        </if>     
        ORDER BY 
               od.member_number
              ,od.order_number
              ,od.order_detail_id DESC
    </select>
</mapper>
